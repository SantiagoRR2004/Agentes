@startuml
start
:!start;
:Esperar 2000ms;
:!main;

partition "Bucle Principal (!main)" {
  if (¿intruderDetected(Room)?) then (sí)
    :!runFromIntruder(Room);
    :Calcular habitación más lejana;
    :!escapeToRoom(SafeRoom);
  elseif (¿needToCharge(Robot)?) then (sí)
    :!recharge(Robot);
    if (¿Cargando al robot?) then (sí)
      if (¿En cargador?) then (sí)
        :drop (Dejar robot);
        :Enviar moveTowardsAdvanced(charger) al Robot;
      else (no)
        :Enviar moveTowardsAdvanced(charger) al Robot;
        :!moveTowardsAdvanced(charger);
      endif
    else (no)
      if (¿Junto al robot?) then (sí)
        :take (Coger robot);
      else (no)
        :!moveTowardsAdvanced(Robot);
      endif
    endif
  elseif (¿unknownAgentDetected?) then (sí)
    :!greetIntruder;
    if (¿En la misma habitación?) then (sí)
      :Interrogar agente (askOne);
      if (¿Respuesta == friendly?) then (sí)
        :Asignar habitación de invitado;
        :Eliminar unknownAgentDetected;
      else (no)
        :alert();
        :Marcar como intruso (intruderDetected);
      endif
    else (no)
      :!goToRoom(Room);
    endif
  elseif (¿wantToSit?) then (sí)
    :!sitOnObjective;
  elseif (¿wantToSleep?) then (sí)
    :!sleepOnObjective;
  else
    :!chooseObjective;
    note right
      Elección aleatoria:
      - 49.5% Sit
      - 49.5% Sleep
      - 1% Beehive
    end note
  endif
}

:Repetir !main;
stop
@enduml